# Fastfile for HomeInventory

default_platform(:ios)

platform :ios do
  # Helper lane to handle build number increment
  private_lane :ensure_build_number do
    # Get current build number
    current_build = get_build_number(xcodeproj: "HomeInventoryModular.xcodeproj").to_i
    
    # Ensure it's at least 2 (since build 1 exists)
    if current_build < 2
      increment_build_number(
        build_number: 2,
        xcodeproj: "HomeInventoryModular.xcodeproj"
      )
    end
  end

  desc "Build the app for development"
  lane :build_dev do
    ensure_build_number
    
    build_app(
      scheme: "HomeInventoryModular",
      configuration: "Debug",
      export_method: "development",
      output_directory: "./build",
      output_name: "HomeInventory_Dev"
    )
    
    UI.success("âœ… Development build complete!")
  end

  desc "Build the app for TestFlight (without upload)"
  lane :build_only do
    ensure_build_number
    
    build_app(
      scheme: "HomeInventoryModular",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "HomeInventory",
      clean: true,
      export_options: {
        signingStyle: "automatic",
        teamID: "2VXBQV4XC9"
      }
    )
    
    UI.success("âœ… App built successfully! IPA available at ./build/HomeInventory.ipa")
  end

  desc "Build and upload to TestFlight using Xcode archive"
  lane :testflight_xcode do |options|
    # Skip git check if forced
    unless options[:force]
      ensure_git_status_clean
    end
    
    ensure_build_number
    
    # First, let's just build the archive
    build_app(
      scheme: "HomeInventoryModular",
      configuration: "Release",
      skip_archive: false,
      archive_path: "./build/HomeInventory.xcarchive",
      skip_package_ipa: true,
      clean: true
    )
    
    UI.success("âœ… Archive created successfully!")
    
    # Now try to export and upload using xcodebuild
    sh("xcodebuild -exportArchive -archivePath ./build/HomeInventory.xcarchive -exportOptionsPlist ./ExportOptions.plist -exportPath ./build/")
    
    # Upload to TestFlight
    upload_to_testflight(
      ipa: "./build/HomeInventoryModular.ipa",
      app_identifier: "com.homeinventory.app",
      skip_waiting_for_build_processing: true,
      skip_submission: false,
      distribute_external: false,
      changelog: "ðŸŽ‰ Home Inventory v1.0.5 - Major Update!\n\nðŸ“± ENHANCED iPAD EXPERIENCE\nâ€¢ New sidebar navigation with split view support\nâ€¢ Apple Pencil annotation support\nâ€¢ Comprehensive keyboard shortcuts\nâ€¢ Drag & drop functionality\n\nðŸ” ADVANCED SECURITY\nâ€¢ Two-factor authentication (2FA)\nâ€¢ Private mode with biometric lock\nâ€¢ Auto-lock with configurable timeout\nâ€¢ AES-256 encrypted backups\n\nðŸ“Š POWERFUL ANALYTICS & REPORTS\nâ€¢ PDF report generation for insurance\nâ€¢ Category spending analysis\nâ€¢ Depreciation tracking\nâ€¢ Budget dashboard with limits\n\nðŸ’° FINANCIAL FEATURES\nâ€¢ Multi-currency support with real-time conversion\nâ€¢ Insurance integration dashboard\nâ€¢ Warranty management and reminders\nâ€¢ Maintenance scheduling\n\nðŸ“§ GMAIL INTEGRATION\nâ€¢ Automatic receipt import from Gmail\nâ€¢ AI-powered receipt categorization\nâ€¢ Bulk import capabilities\nâ€¢ Smart email filtering\n\nðŸ  FAMILY & COLLABORATION\nâ€¢ Family sharing with permission controls\nâ€¢ Collaborative inventory lists\nâ€¢ Activity tracking and history\nâ€¢ Multi-user support\n\nðŸ” ADVANCED SEARCH\nâ€¢ Natural language search\nâ€¢ Voice search commands\nâ€¢ Image similarity search\nâ€¢ Smart filtering options\n\nâ˜ï¸ SYNC & BACKUP\nâ€¢ Multi-platform synchronization\nâ€¢ Automatic cloud backups\nâ€¢ Offline mode support\nâ€¢ Smart conflict resolution\n\nâš¡ PERFORMANCE IMPROVEMENTS\nâ€¢ 40% faster app launch\nâ€¢ 25% reduced memory usage\nâ€¢ Enhanced battery efficiency\nâ€¢ Improved network performance\n\nðŸŽ¨ UI/UX ENHANCEMENTS\nâ€¢ Full dark mode support\nâ€¢ Enhanced accessibility\nâ€¢ Smooth animations\nâ€¢ Dynamic type support\n\nðŸ› BUG FIXES & STABILITY\nâ€¢ Fixed receipt import crashes\nâ€¢ Resolved sync conflicts\nâ€¢ Improved barcode scanner reliability\nâ€¢ Better error handling\n\nðŸ”’ PRIVACY & SECURITY\nâ€¢ GDPR/CCPA compliant\nâ€¢ Local biometric authentication\nâ€¢ No third-party data sharing\nâ€¢ Full encryption compliance\n\nTesting Instructions:\nâ€¢ Test item management and barcode scanning\nâ€¢ Try Gmail receipt import\nâ€¢ Verify sync across devices\nâ€¢ Test iPad-specific features\nâ€¢ Check accessibility with VoiceOver\n\nFeedback: griffinradcliffe@gmail.com",
      beta_app_description: "Home Inventory - The most comprehensive personal inventory management app. Track belongings, manage warranties, generate insurance reports, and collaborate with family. Features advanced security, multi-currency support, Gmail integration, and powerful analytics. Perfect for insurance documentation, moving, and organization.",
      beta_app_feedback_email: "griffinradcliffe@gmail.com"
    )
    
    UI.success("âœ… Successfully uploaded to TestFlight!")
  end

  desc "Build and upload to TestFlight"
  lane :testflight do |options|
    # Skip git check if forced
    unless options[:force]
      ensure_git_status_clean
    end
    
    ensure_build_number
    
    # Build the app - let Xcode handle provisioning
    build_app(
      scheme: "HomeInventoryModular",
      configuration: "Release", 
      export_method: "app-store",
      clean: true,
      xcargs: "-allowProvisioningUpdates"
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      app_identifier: "com.homeinventory.app",
      skip_waiting_for_build_processing: true,
      skip_submission: false,
      distribute_external: false,
      changelog: "ðŸŽ‰ Home Inventory v1.0.5 - Major Update!\n\nðŸ“± ENHANCED iPAD EXPERIENCE\nâ€¢ New sidebar navigation with split view support\nâ€¢ Apple Pencil annotation support\nâ€¢ Comprehensive keyboard shortcuts\nâ€¢ Drag & drop functionality\n\nðŸ” ADVANCED SECURITY\nâ€¢ Two-factor authentication (2FA)\nâ€¢ Private mode with biometric lock\nâ€¢ Auto-lock with configurable timeout\nâ€¢ AES-256 encrypted backups\n\nðŸ“Š POWERFUL ANALYTICS & REPORTS\nâ€¢ PDF report generation for insurance\nâ€¢ Category spending analysis\nâ€¢ Depreciation tracking\nâ€¢ Budget dashboard with limits\n\nðŸ’° FINANCIAL FEATURES\nâ€¢ Multi-currency support with real-time conversion\nâ€¢ Insurance integration dashboard\nâ€¢ Warranty management and reminders\nâ€¢ Maintenance scheduling\n\nðŸ“§ GMAIL INTEGRATION\nâ€¢ Automatic receipt import from Gmail\nâ€¢ AI-powered receipt categorization\nâ€¢ Bulk import capabilities\nâ€¢ Smart email filtering\n\nðŸ  FAMILY & COLLABORATION\nâ€¢ Family sharing with permission controls\nâ€¢ Collaborative inventory lists\nâ€¢ Activity tracking and history\nâ€¢ Multi-user support\n\nðŸ” ADVANCED SEARCH\nâ€¢ Natural language search\nâ€¢ Voice search commands\nâ€¢ Image similarity search\nâ€¢ Smart filtering options\n\nâ˜ï¸ SYNC & BACKUP\nâ€¢ Multi-platform synchronization\nâ€¢ Automatic cloud backups\nâ€¢ Offline mode support\nâ€¢ Smart conflict resolution\n\nâš¡ PERFORMANCE IMPROVEMENTS\nâ€¢ 40% faster app launch\nâ€¢ 25% reduced memory usage\nâ€¢ Enhanced battery efficiency\nâ€¢ Improved network performance\n\nðŸŽ¨ UI/UX ENHANCEMENTS\nâ€¢ Full dark mode support\nâ€¢ Enhanced accessibility\nâ€¢ Smooth animations\nâ€¢ Dynamic type support\n\nðŸ› BUG FIXES & STABILITY\nâ€¢ Fixed receipt import crashes\nâ€¢ Resolved sync conflicts\nâ€¢ Improved barcode scanner reliability\nâ€¢ Better error handling\n\nðŸ”’ PRIVACY & SECURITY\nâ€¢ GDPR/CCPA compliant\nâ€¢ Local biometric authentication\nâ€¢ No third-party data sharing\nâ€¢ Full encryption compliance\n\nTesting Instructions:\nâ€¢ Test item management and barcode scanning\nâ€¢ Try Gmail receipt import\nâ€¢ Verify sync across devices\nâ€¢ Test iPad-specific features\nâ€¢ Check accessibility with VoiceOver\n\nFeedback: griffinradcliffe@gmail.com",
      beta_app_description: "Home Inventory - The most comprehensive personal inventory management app. Track belongings, manage warranties, generate insurance reports, and collaborate with family. Features advanced security, multi-currency support, Gmail integration, and powerful analytics. Perfect for insurance documentation, moving, and organization.",
      beta_app_feedback_email: "griffinradcliffe@gmail.com"
    )
    
    UI.success("âœ… Successfully uploaded to TestFlight!")
    
    # Only commit if git was clean
    unless options[:force]
      commit_version_bump(
        message: "[skip ci] Bump build number for TestFlight",
        xcodeproj: "HomeInventoryModular.xcodeproj"
      )
      
      push_to_git_remote
    end
  end

  desc "Fix common build issues"
  lane :fix_build do
    # Clean build folder
    clean_build_artifacts
    
    # Clear derived data
    clear_derived_data
    
    # Resolve packages
    sh("xcodebuild -resolvePackageDependencies -scheme HomeInventoryModular -project ../HomeInventoryModular.xcodeproj")
    
    UI.success("âœ… Build issues fixed! Try building again.")
  end

  desc "Resolve SPM dependencies"
  lane :resolve_dependencies do
    sh("xcodebuild -resolvePackageDependencies -workspace ../HomeInventoryModular.xcworkspace -scheme HomeInventoryModular")
    UI.success("âœ… Dependencies resolved!")
  end


  desc "Validate the app before submission"
  lane :validate do
    # Build the app
    build_only
    
    # Validate with App Store Connect
    validate_app(
      ipa: "./build/HomeInventory.ipa",
      platform: "ios"
    )
    
    UI.success("âœ… App validation passed!")
  end

  # Error handler
  error do |lane, exception, options|
    UI.error("âŒ Error in lane #{lane}: #{exception.message}")
    
    if exception.message.include?("Code signing") || exception.message.include?("provisioning")
      UI.important("ðŸ’¡ Try running 'fastlane fix_build' to resolve common issues")
      UI.important("ðŸ’¡ You may need to open Xcode and ensure automatic signing is enabled")
    end
  end
end